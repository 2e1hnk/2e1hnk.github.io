<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="/media/css/all.css">

    <title>2m FMAC/UKAC April 2018</title>
    <meta name="description" content="Test
">

      <!-- LeafletJS CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="">
  <link rel="stylesheet" href="/media/css/L.fullscreen.css" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
  <script src="/media/js/leaflet-heatmap.js"></script>
  <script src="/media/js/HamGridSquare.js"></script>
  <script src="/media/js/adif.js"></script>
  <script src="/media/js/chart.min.js"></script>
        
    <style>
      .header {
        background-image: url(/media/images/antennafield.jpg);
        background-position-x: 50%;
        background-position-y: 50%;
        background-size: 100%;
        display: block;
        background-attachment: fixed;
        color: white;
        text-align: center;
        vertical-align: middle;
        margin-bottom: 20px;
      }

      .header-text {
        padding-top: 100px;
        padding-bottom: 100px;
      }

      section {
        padding-top: 10px;
      }

      footer {
        margin-top: 50px;
        padding-top: 20px;
        padding-bottom: 20px;
      }
    </style>

  </head>
  <body id="fmac-ukac-april-2018">
    <div class="container-fluid header">
      <div class="col-md-8 offset-md-2">
        <nav class="navbar navbar-expand-lg navbar-dark bg-transparent">
          <a class="navbar-brand" href="#">MØIZZ</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                                          <li class="nav-item">
                <a class="nav-link" href="/about.html">About</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/blog/">Blog</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/contests/">Contest Reports</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/projects/">Projects</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Tools
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/ogps/">OGPS</a>
                  <a class="dropdown-item" href="/morsechallenge/">Morse Challenge</a>
                  <!--
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#">Something else here</a>
                  -->
                </div>
              </li>
            </ul>
            <!--
            <form class="form-inline my-2 my-lg-0">
              <input id="searchCallsign" class="form-control mr-sm-2" type="search" placeholder="Search the Logbook" aria-label="Search">
              <button class="btn btn-outline-success my-2 my-sm-0" id="btnLogSearch">Search</button>
            </form>
            -->
          </div>
        </nav>

        <h1 class="header-text display-1">  2m FMAC/UKAC April 2018
</h1>
        <h4 class="header-text display-4"></h4>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="col-md-8 offset-md-2">
          <section>
    <em class="text-muted">By Matt, 2E1HNK on <time datetime="2018-04-03">Tue, 03 Apr 2018</time></em>
  </section>

  <section>
          <div class="tags">
              <a class="btn btn-outline-secondary btn-sm" href="/blog/tags/FMAC.html">FMAC</a>
              <a class="btn btn-outline-secondary btn-sm" href="/blog/tags/UKAC.html">UKAC</a>
              <a class="btn btn-outline-secondary btn-sm" href="/blog/tags/Activation.html">Activation</a>
          </div>
  
  </section>

  <section>
          <center>
        <img class="img-fluid" style="margin-top: 20px; margin-bottom: 20px;" src="/media/images/2018-04-03-2m-FMAC.png" />
      </center>
      </section>

  <section>
    <p>Participated in both the 2m FMAC and UKAC events with a family meal
in the middle.
FMAC was just a single contact with the ever-present
M0RKX/P. I was hoping to get M0RSD too as I’d heard him a few
minutes earlier doing a demo for some foundation students but he
either had other commitments or Alcester-Dudley was a no-go.
Operated from the car park of the Moat House, Alcester (IO92BF, 21m
asl) using a Baofeng UV5R and the 2m/70cm mini magnetic whip that I
picked up in the Maplin closing-down sale a few weeks ago. I
started operating for the UKAC at about 9pm (2000 UTC), having
missed the first hour of the contest due to family commitments. I
made 11 contacts across 4 grid squares with the best DX being
G0HEL/P in IO81WG at about 107km - not too bad off a vertical.
Operating location was chosen primarily for its proximity to my
route home from the restaurant and was a lay-by off the B4088 just
south of the junction with the A422 (IO92AF, 122m asl). It was
surprisingly comfortable with the lay-by being set back from the
road and separated from it by some trees. This reduced the sound of
passing vehicles (not that there were many) and reduced the chance
of muggles taking an interest. This was the first outing for both
my Yaesu FT857d and Diamond X200. There was a small issue with the
FT857d (<a href="/blog/TechNote/1.html">see TechNote#1</a>) but
that was resolved on-site. The setup performed well, but has left
me wanting a 2m Yagi! The next problem that I encountered was when
I tried to submit the log the following day - I submitted it fine
but got an email enquiring about my RSGB membership status - I
hadn't realised that membership was a prerequisite for entering.</p>
<p>Total QSOs: 1</p>
<p>Total Points: 24</p>
<p>Normalised Points: 143</p>
<p>ODX: M0RKX/P (IO92BA - 24km)</p>
<p>Final Position: 19 (of 21)</p>  </section>


      <br />
    <h2>UKAC</h2>
          <div id="stats-UKAC">
  <p>Total QSOs: <span id="stats-UKAC-totalqsos">?</span></p>
  <p>Total Points: <span id="stats-UKAC-total">?</span> (<span id="stats-UKAC-points">?</span> QSO points + <span id="stats-UKAC-bonus">?</span> bonus points)</p>
  <p>ODX: <span id="stats-UKAC-odx">?</span></p>
</div>

<script>
  var myLocation = [];
  gridSquareToLatLon("IO92bf", myLocation);

  readTextFile("/media/logs/2E1HNK_2018_04_03_144 MHz_UKAC.adi", function(log) {
    totalQsos = 0;
    odxDist = 0;
    points = 0;
    bonusSquares = [];
    odx = "";
    for(var i=0; i<log.length; i++) {
      if ( log[i].latitude && log[i].longitude ) {
        if ( distBetweenLocations(myLocation.lat, myLocation.lon, log[i].latitude, log[i].longitude) > odxDist ) {
          odxDist = distBetweenLocations(myLocation.lat, myLocation.lon, log[i].latitude, log[i].longitude);
          odx = log[i].callsign + " (" + log[i].locator + ", " + Math.round(odxDist) + "km)"
        }
      }
      if ( !bonusSquares.includes(log[i].locator.substring(0,4)) ) {
        bonusSquares.push(log[i].locator.substring(0,4));
      }
      totalQsos++;
      points += log[i].points;
    }
    document.getElementById("stats-UKAC-totalqsos").textContent = totalQsos;
    document.getElementById("stats-UKAC-points").textContent = points;
    document.getElementById("stats-UKAC-bonus").textContent = bonusSquares.length * 500;
    document.getElementById("stats-UKAC-total").textContent = points + bonusSquares.length * 500;
    document.getElementById("stats-UKAC-odx").textContent = odx;
  });
</script>


        <div id="container" style="width: 100%;">
  <canvas id="rateChart-UKAC" class="rate-chart"></canvas>
</div>
<div style="height: 450px" id="map-UKAC"></div>

<script src="/media/js/chartjs.plugin.annotation.js"></script>
<script src="/media/js/L.maidenheadcoloured.js"></script>
<script src="/media/js/L.fullscreen.js"></script>
<script>
  var myLocation = [];

  gridSquareToLatLon("IO92bf", myLocation);

  var osmLayerUKAC = L.tileLayer('//tileserver.eastus.cloudapp.azure.com/{id}/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'ham'
  });

  var lightTilesUKAC = L.tileLayer('//cartodb-basemaps-{s}.global.ssl.fastly.net/{id}/{z}/{x}/{y}.png', {
    attribution: 'Map tiles by Carto, under CC BY 3.0. Data by <a href="//www.openstreetmap.org/">OpenStreetMap</a>, under ODbL.',
    maxZoom: 18,
    id: 'light_all'
  });

  var darkTilesUKAC = L.tileLayer('//cartodb-basemaps-{s}.global.ssl.fastly.net/{id}/{z}/{x}/{y}.png', {
    attribution: 'Map tiles by Carto, under CC BY 3.0. Data by <a href="//www.openstreetmap.org/">OpenStreetMap</a>, under ODbL.',
    maxZoom: 18,
    id: 'dark_all'
  });

  var portableIcon = L.icon({
    iconUrl: '/media/svg/portable.svg',
    iconSize:     [30, 30], // size of the icon
    iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -30] // point from which the popup should open relative to the iconAnchor
  });

  var mobileIcon = L.icon({
    iconUrl: '/media/svg/mobile.svg',
    iconSize:     [30, 30], // size of the icon
    iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -30] // point from which the popup should open relative to the iconAnchor
  });

  var baseIcon = L.icon({
    iconUrl: '/media/svg/base.svg',
    iconSize:     [30, 30], // size of the icon
    iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -30] // point from which the popup should open relative to the iconAnchor
  });

  var myIcon = L.icon({
    iconUrl: '/media/svg/me-portable.svg',
    iconSize:     [30, 30], // size of the icon
    iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -30]  // point from which the popup should open relative to the iconAnchor
  });

  var heatmapLayerUKAC = L.heatLayer([], {radius: 80, maxZoom: 16});

  var stationsLayerUKAC = L.featureGroup([]);

  var gridLayerUKAC = L.maidenhead({ worked: [], confirmed: [] });
  gridLayerUKAC._map = mapUKAC;

  stationsLayerUKAC.addLayer(
    L.marker(
      [myLocation.lat, myLocation.lon],
      {icon: myIcon}
    ).bindPopup(
      "<b>IO92bf<br />"
    )
  );

  readTextFile("/media/logs/2E1HNK_2018_04_03_144 MHz_UKAC.adi", function(log) {
    rateUKAC = {};
    opmodeUKAC = [];
    var currMode = "s_p";
    var lastRunStart = "";

    rateGroupInterval = 5;   // Interval (in minutes) to group QSOs for the rate graph

    for(var i=0; i<log.length; i++) {
      if ( log[i].latitude && log[i].longitude ) {
        var added = false;
        for ( var j=0; j<heatmapLayerUKAC._latlngs.length; j++ ) {
          if ( heatmapLayerUKAC._latlngs[j][0] == log[i].latitude && heatmapLayerUKAC._latlngs[j][1] == log[i].longitude ) {
            var count = heatmapLayerUKAC._latlngs[j][2] + 1;
            console.log("In heatmap, setting count to " + count);
            heatmapLayerUKAC._latlngs[j] = [log[i].latitude, log[i].longitude, count];
            added = true;
          }
        }
        if ( !added ) {
          heatmapLayerUKAC.addLatLng([log[i].latitude, log[i].longitude, 1]);
        }

        console.log(heatmapLayerUKAC);
        if ( log[i].callsign.endsWith("/P") ) {
          var iconType = portableIcon;
        } else if ( log[i].callsign.endsWith("/M") ) {
          var iconType = mobileIcon;
        } else {
          var iconType = baseIcon;
        }
          stationsLayerUKAC.addLayer(
            L.marker(
              [log[i].latitude, log[i].longitude],
              {icon: iconType}
            ).bindPopup(
              "<table>" +
              "<tr><th colspan=2><b>" + log[i].callsign + "</b></th></tr>" +
              "<tr><th>Locator:</th><td>" + log[i].locator + "</td></tr>" +
              "<tr><th>Date:</th><td>" + log[i].date.substr(0,4) + "-" + log[i].date.substr(4,2) + "-" + log[i].date.substr(6,2) + "</td></tr>" +
              "<tr><th>Time:</th><td>" + log[i].time.substr(0,2) +":" + log[i].time.substr(2,2) + "</td></tr>" +
              "<tr><th>TX:</th><td>" + log[i].rst_tx + " / " + log[i].serial_tx + "</td></tr>" +
              "<tr><th>RX:</th><td>" + log[i].rst_rx + " / " + log[i].serial_rx + "</td></tr>" +
              "</table>"
            )
          );
      } else if ( log[i].locator ) {
        latlng = gridSquareToLatLon(log[i].locator, log[i]);
        heatmapLayerUKAC.addLatLng([log[i].lat, log[i].lon, 1]);
      }

      // Add to grid shading
      if ( log[i].locator ) {
        gridLayerUKAC.grids.worked.push(log[i].locator);
      }
      gridLayerUKAC.redraw();

      // Add QSO to rate object
      rateKey = log[i].date + " " + Math.floor(parseInt(log[i].time) / rateGroupInterval) * rateGroupInterval;
      rateKey in rateUKAC ? rateUKAC[rateKey]++ : rateUKAC[rateKey] = 1;

      // Work out if we were running or S&P
      if ( i > 1 && i < (log.length-1) ) {
        if ( log[i].frequency == log[i+1].frequency || log[i].frequency == log[i-1].frequency ) {
          // in run mode
          if (currMode == "s_p") {
            // Start a new run session
            lastRunStart = log[i].date + " " + log[i].time;
            currMode = "run";
          } // else still running
        } else {
          if (currMode == "run") {
            // End a run session
            opmodeUKAC.push([lastRunStart, log[i].date + " " + log[i].time]);
            currMode = "s_p";
          } // else still s_p
        }
      }
    }

    mapUKAC.fitBounds(stationsLayerUKAC.getBounds().pad(0.5));

    console.log("rate", rateUKAC);

    var chartDataUKAC = {
      labels: Object.keys(rateUKAC),
      datasets: [{
        label: "QSOs per " + rateGroupInterval + " mins",
        backgroundColor: '#5695c8',
				borderColor: '#31517a',
				borderWidth: 1,
        fill: false,
				data: Object.values(rateUKAC)
      },{
        label: "",
        backgroundColor: '#5695c8',
				borderColor: '#31517a',
				borderWidth: 1,
        fill: false,
				data: opmodeUKAC
      }]
    };

    console.log("chartData", chartDataUKAC);


    // Draw the rate chart
    //window.onload = function() {
      var ctxUKAC = document.getElementById('rateChart-UKAC').getContext('2d');
      window.rateBarChartUKAC = new Chart(ctxUKAC, {
        type: 'line',
        data: chartDataUKAC,
        options: {
          responsive: true,
          run_periods: opmodeUKAC,
          chartArea: {
            backgroundColor: 'rgba(251, 85, 85, 0.4)'
          },
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: 'UKAC Rate Chart'
          },
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: true
              }
            }]
          }
        },
        plugins: {
          annotation: {
            drawTime: 'afterDatasetsDraw',
            annotations: [{
      				id: 'a-line-1', // optional
      				type: 'line',
      				mode: 'horizontal',
      				scaleID: 'y-axis-0',
      				value: '2',
      				borderColor: 'red',
      				borderWidth: 2,

      				// Fires when the user clicks this annotation on the chart
      				// (be sure to enable the event in the events array below).
      				onClick: function(e) {
      					// `this` is bound to the annotation element
      				}
      			}]
          }
        }
      });
      console.log("rate chart", window.rateBarChartUKAC);
    //};
  });

  heatmapLayerUKAC.redraw();

  var basemapsUKAC = {"OpenStreetMap": osmLayerUKAC, "Carto Light": lightTilesUKAC, "Carto Dark": darkTilesUKAC};
  var overlayMapsUKAC = {"Grid": gridLayerUKAC, "Heatmap": heatmapLayerUKAC, "Stations": stationsLayerUKAC};

  var mapUKAC = new L.map('map-UKAC', {
    zoom: 6,
    attributionControl: true,
    fullscreenControl: true,
    layers: [lightTilesUKAC, heatmapLayerUKAC, gridLayerUKAC, stationsLayerUKAC]
  });
  //mapUKAC.setView([51.945732, -1.926986], 6);
  mapUKAC.fitBounds(stationsLayerUKAC.getBounds().pad(0.5));

  L.control.layers(basemapsUKAC, overlayMapsUKAC).addTo(mapUKAC);

</script>


      <br />
    <h2>FMAC</h2>
          <div id="stats-FMAC">
  <p>Total QSOs: <span id="stats-FMAC-totalqsos">?</span></p>
  <p>Total Points: <span id="stats-FMAC-total">?</span> (<span id="stats-FMAC-points">?</span> QSO points + <span id="stats-FMAC-bonus">?</span> bonus points)</p>
  <p>ODX: <span id="stats-FMAC-odx">?</span></p>
</div>

<script>
  var myLocation = [];
  gridSquareToLatLon("IO92bf", myLocation);

  readTextFile("/media/logs/2E1HNK_2018_04_03_144 MHz_FMAC.adi", function(log) {
    totalQsos = 0;
    odxDist = 0;
    points = 0;
    bonusSquares = [];
    odx = "";
    for(var i=0; i<log.length; i++) {
      if ( log[i].latitude && log[i].longitude ) {
        if ( distBetweenLocations(myLocation.lat, myLocation.lon, log[i].latitude, log[i].longitude) > odxDist ) {
          odxDist = distBetweenLocations(myLocation.lat, myLocation.lon, log[i].latitude, log[i].longitude);
          odx = log[i].callsign + " (" + log[i].locator + ", " + Math.round(odxDist) + "km)"
        }
      }
      if ( !bonusSquares.includes(log[i].locator.substring(0,4)) ) {
        bonusSquares.push(log[i].locator.substring(0,4));
      }
      totalQsos++;
      points += log[i].points;
    }
    document.getElementById("stats-FMAC-totalqsos").textContent = totalQsos;
    document.getElementById("stats-FMAC-points").textContent = points;
    document.getElementById("stats-FMAC-bonus").textContent = bonusSquares.length * 500;
    document.getElementById("stats-FMAC-total").textContent = points + bonusSquares.length * 500;
    document.getElementById("stats-FMAC-odx").textContent = odx;
  });
</script>


        <div id="container" style="width: 100%;">
  <canvas id="rateChart-FMAC" class="rate-chart"></canvas>
</div>
<div style="height: 450px" id="map-FMAC"></div>

<script src="/media/js/chartjs.plugin.annotation.js"></script>
<script src="/media/js/L.maidenheadcoloured.js"></script>
<script src="/media/js/L.fullscreen.js"></script>
<script>
  var myLocation = [];

  gridSquareToLatLon("IO92bf", myLocation);

  var osmLayerFMAC = L.tileLayer('//tileserver.eastus.cloudapp.azure.com/{id}/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'ham'
  });

  var lightTilesFMAC = L.tileLayer('//cartodb-basemaps-{s}.global.ssl.fastly.net/{id}/{z}/{x}/{y}.png', {
    attribution: 'Map tiles by Carto, under CC BY 3.0. Data by <a href="//www.openstreetmap.org/">OpenStreetMap</a>, under ODbL.',
    maxZoom: 18,
    id: 'light_all'
  });

  var darkTilesFMAC = L.tileLayer('//cartodb-basemaps-{s}.global.ssl.fastly.net/{id}/{z}/{x}/{y}.png', {
    attribution: 'Map tiles by Carto, under CC BY 3.0. Data by <a href="//www.openstreetmap.org/">OpenStreetMap</a>, under ODbL.',
    maxZoom: 18,
    id: 'dark_all'
  });

  var portableIcon = L.icon({
    iconUrl: '/media/svg/portable.svg',
    iconSize:     [30, 30], // size of the icon
    iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -30] // point from which the popup should open relative to the iconAnchor
  });

  var mobileIcon = L.icon({
    iconUrl: '/media/svg/mobile.svg',
    iconSize:     [30, 30], // size of the icon
    iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -30] // point from which the popup should open relative to the iconAnchor
  });

  var baseIcon = L.icon({
    iconUrl: '/media/svg/base.svg',
    iconSize:     [30, 30], // size of the icon
    iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -30] // point from which the popup should open relative to the iconAnchor
  });

  var myIcon = L.icon({
    iconUrl: '/media/svg/me-portable.svg',
    iconSize:     [30, 30], // size of the icon
    iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -30]  // point from which the popup should open relative to the iconAnchor
  });

  var heatmapLayerFMAC = L.heatLayer([], {radius: 80, maxZoom: 16});

  var stationsLayerFMAC = L.featureGroup([]);

  var gridLayerFMAC = L.maidenhead({ worked: [], confirmed: [] });
  gridLayerFMAC._map = mapFMAC;

  stationsLayerFMAC.addLayer(
    L.marker(
      [myLocation.lat, myLocation.lon],
      {icon: myIcon}
    ).bindPopup(
      "<b>IO92bf<br />"
    )
  );

  readTextFile("/media/logs/2E1HNK_2018_04_03_144 MHz_FMAC.adi", function(log) {
    rateFMAC = {};
    opmodeFMAC = [];
    var currMode = "s_p";
    var lastRunStart = "";

    rateGroupInterval = 5;   // Interval (in minutes) to group QSOs for the rate graph

    for(var i=0; i<log.length; i++) {
      if ( log[i].latitude && log[i].longitude ) {
        var added = false;
        for ( var j=0; j<heatmapLayerFMAC._latlngs.length; j++ ) {
          if ( heatmapLayerFMAC._latlngs[j][0] == log[i].latitude && heatmapLayerFMAC._latlngs[j][1] == log[i].longitude ) {
            var count = heatmapLayerFMAC._latlngs[j][2] + 1;
            console.log("In heatmap, setting count to " + count);
            heatmapLayerFMAC._latlngs[j] = [log[i].latitude, log[i].longitude, count];
            added = true;
          }
        }
        if ( !added ) {
          heatmapLayerFMAC.addLatLng([log[i].latitude, log[i].longitude, 1]);
        }

        console.log(heatmapLayerFMAC);
        if ( log[i].callsign.endsWith("/P") ) {
          var iconType = portableIcon;
        } else if ( log[i].callsign.endsWith("/M") ) {
          var iconType = mobileIcon;
        } else {
          var iconType = baseIcon;
        }
          stationsLayerFMAC.addLayer(
            L.marker(
              [log[i].latitude, log[i].longitude],
              {icon: iconType}
            ).bindPopup(
              "<table>" +
              "<tr><th colspan=2><b>" + log[i].callsign + "</b></th></tr>" +
              "<tr><th>Locator:</th><td>" + log[i].locator + "</td></tr>" +
              "<tr><th>Date:</th><td>" + log[i].date.substr(0,4) + "-" + log[i].date.substr(4,2) + "-" + log[i].date.substr(6,2) + "</td></tr>" +
              "<tr><th>Time:</th><td>" + log[i].time.substr(0,2) +":" + log[i].time.substr(2,2) + "</td></tr>" +
              "<tr><th>TX:</th><td>" + log[i].rst_tx + " / " + log[i].serial_tx + "</td></tr>" +
              "<tr><th>RX:</th><td>" + log[i].rst_rx + " / " + log[i].serial_rx + "</td></tr>" +
              "</table>"
            )
          );
      } else if ( log[i].locator ) {
        latlng = gridSquareToLatLon(log[i].locator, log[i]);
        heatmapLayerFMAC.addLatLng([log[i].lat, log[i].lon, 1]);
      }

      // Add to grid shading
      if ( log[i].locator ) {
        gridLayerFMAC.grids.worked.push(log[i].locator);
      }
      gridLayerFMAC.redraw();

      // Add QSO to rate object
      rateKey = log[i].date + " " + Math.floor(parseInt(log[i].time) / rateGroupInterval) * rateGroupInterval;
      rateKey in rateFMAC ? rateFMAC[rateKey]++ : rateFMAC[rateKey] = 1;

      // Work out if we were running or S&P
      if ( i > 1 && i < (log.length-1) ) {
        if ( log[i].frequency == log[i+1].frequency || log[i].frequency == log[i-1].frequency ) {
          // in run mode
          if (currMode == "s_p") {
            // Start a new run session
            lastRunStart = log[i].date + " " + log[i].time;
            currMode = "run";
          } // else still running
        } else {
          if (currMode == "run") {
            // End a run session
            opmodeFMAC.push([lastRunStart, log[i].date + " " + log[i].time]);
            currMode = "s_p";
          } // else still s_p
        }
      }
    }

    mapFMAC.fitBounds(stationsLayerFMAC.getBounds().pad(0.5));

    console.log("rate", rateFMAC);

    var chartDataFMAC = {
      labels: Object.keys(rateFMAC),
      datasets: [{
        label: "QSOs per " + rateGroupInterval + " mins",
        backgroundColor: '#5695c8',
				borderColor: '#31517a',
				borderWidth: 1,
        fill: false,
				data: Object.values(rateFMAC)
      },{
        label: "",
        backgroundColor: '#5695c8',
				borderColor: '#31517a',
				borderWidth: 1,
        fill: false,
				data: opmodeFMAC
      }]
    };

    console.log("chartData", chartDataFMAC);


    // Draw the rate chart
    //window.onload = function() {
      var ctxFMAC = document.getElementById('rateChart-FMAC').getContext('2d');
      window.rateBarChartFMAC = new Chart(ctxFMAC, {
        type: 'line',
        data: chartDataFMAC,
        options: {
          responsive: true,
          run_periods: opmodeFMAC,
          chartArea: {
            backgroundColor: 'rgba(251, 85, 85, 0.4)'
          },
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: 'FMAC Rate Chart'
          },
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: true
              }
            }]
          }
        },
        plugins: {
          annotation: {
            drawTime: 'afterDatasetsDraw',
            annotations: [{
      				id: 'a-line-1', // optional
      				type: 'line',
      				mode: 'horizontal',
      				scaleID: 'y-axis-0',
      				value: '2',
      				borderColor: 'red',
      				borderWidth: 2,

      				// Fires when the user clicks this annotation on the chart
      				// (be sure to enable the event in the events array below).
      				onClick: function(e) {
      					// `this` is bound to the annotation element
      				}
      			}]
          }
        }
      });
      console.log("rate chart", window.rateBarChartFMAC);
    //};
  });

  heatmapLayerFMAC.redraw();

  var basemapsFMAC = {"OpenStreetMap": osmLayerFMAC, "Carto Light": lightTilesFMAC, "Carto Dark": darkTilesFMAC};
  var overlayMapsFMAC = {"Grid": gridLayerFMAC, "Heatmap": heatmapLayerFMAC, "Stations": stationsLayerFMAC};

  var mapFMAC = new L.map('map-FMAC', {
    zoom: 6,
    attributionControl: true,
    fullscreenControl: true,
    layers: [lightTilesFMAC, heatmapLayerFMAC, gridLayerFMAC, stationsLayerFMAC]
  });
  //mapFMAC.setView([51.945732, -1.926986], 6);
  mapFMAC.fitBounds(stationsLayerFMAC.getBounds().pad(0.5));

  L.control.layers(basemapsFMAC, overlayMapsFMAC).addTo(mapFMAC);

</script>


          </div>
      </div>
    </div>

    <footer class="bg-dark">
      <div class="container">
        <div class="row">
          <div class="col-md-2 offset-md-3 text-center">
            <a href="https://twitter.com/MØIZZ_Matt"><i class="fab fa-twitter display-4 text-light"></i></a>
          </div>
          <div class="col-md-2 text-center">
            <a href="https://github.com/2e1hnk"><i class="fab fa-github display-4 text-light"></i></a>
          </div>
          <div class="col-md-2 text-center">
            <a href="https://reddit.com/user/2e1hnk"><i class="fab fa-reddit display-4 text-light"></i></a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script type="text/javascript">
        document.getElementById("btnLogSearch").onclick = function () {
            var url = "/logsearch.html?callsign=" + document.getElementById("searchCallsign").value;
            location.href(url);
            return false;
        };
    </script>
  </body>
</html>